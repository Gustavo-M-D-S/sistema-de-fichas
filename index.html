const API_BASE_URL = 'https://seu-backend.herokuapp.com'; // Substitua pela URL do seu backend

// Gerenciamento de estado
let currentUser = null;

// Funções de navegação
function showScreen(screenId) {
    document.querySelectorAll('.screen').forEach(screen => {
        screen.classList.remove('active');
    });
    document.getElementById(screenId).classList.add('active');
}

// Autenticação
document.getElementById('login-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;

    try {
        const response = await fetch(`${API_BASE_URL}/auth/login`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ email, password })
        });

        const data = await response.json();
        
        if (response.ok) {
            currentUser = data.user;
            localStorage.setItem('token', data.token);
            localStorage.setItem('user', JSON.stringify(data.user));
            
            if (data.user.role === 'admin') {
                showScreen('admin-dashboard');
                loadMembers();
            } else {
                showScreen('member-dashboard');
                loadMemberForm();
            }
        } else {
            alert(data.error || 'Erro no login');
        }
    } catch (error) {
        alert('Erro de conexão');
    }
});

document.getElementById('register-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const userData = {
        name: document.getElementById('reg-name').value,
        email: document.getElementById('reg-email').value,
        password: document.getElementById('reg-password').value,
        role: document.getElementById('reg-role').value
    };

    try {
        const response = await fetch(`${API_BASE_URL}/auth/register`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(userData)
        });

        const data = await response.json();
        
        if (response.ok) {
            alert('Registro realizado com sucesso!');
            showScreen('login-screen');
        } else {
            alert(data.error || 'Erro no registro');
        }
    } catch (error) {
        alert('Erro de conexão');
    }
});

// Funções do Admin
async function loadMembers() {
    try {
        const token = localStorage.getItem('token');
        const response = await fetch(`${API_BASE_URL}/members`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (response.ok) {
            const members = await response.json();
            displayMembers(members);
        }
    } catch (error) {
        console.error('Erro ao carregar membros:', error);
    }
}

function displayMembers(members) {
    const container = document.getElementById('members-list');
    container.innerHTML = '';

    members.forEach(member => {
        const card = document.createElement('div');
        card.className = 'member-card';
        card.innerHTML = `
            <h3>${member.name}</h3>
            <p><strong>Email:</strong> ${member.email}</p>
            <p><strong>Entrada:</strong> ${formatDate(member.entryDate)}</p>
            <p><strong>Saída:</strong> ${member.exitDate ? formatDate(member.exitDate) : 'Ativo'}</p>
            <p><strong>Cargo:</strong> ${member.position}</p>
            <button onclick="openEditModal('${member._id}')">Editar</button>
        `;
        container.appendChild(card);
    });
}

function openEditModal(memberId) {
    // Buscar dados do membro e preencher o modal
    // Implementar conforme necessário
    document.getElementById('edit-modal').style.display = 'block';
}

function closeModal() {
    document.getElementById('edit-modal').style.display = 'none';
}

// Funções do Membro
function loadMemberForm() {
    const user = JSON.parse(localStorage.getItem('user'));
    const container = document.getElementById('member-form-container');
    
    container.innerHTML = `
        <div class="member-form">
            <form id="update-member-form">
                <div>
                    <label>Nome:</label>
                    <input type="text" id="member-name" value="${user.name}" required>
                </div>
                <div>
                    <label>Email:</label>
                    <input type="email" id="member-email" value="${user.email}" required>
                </div>
                <div>
                    <label>Data de Entrada:</label>
                    <input type="date" id="member-entry-date" value="${user.entryDate}" required>
                </div>
                <div>
                    <label>Data de Saída:</label>
                    <input type="date" id="member-exit-date" value="${user.exitDate || ''}">
                </div>
                <div>
                    <label>Cargo:</label>
                    <input type="text" id="member-position" value="${user.position}" required>
                </div>
                <button type="submit">Atualizar Ficha</button>
            </form>
        </div>
    `;

    document.getElementById('update-member-form').addEventListener('submit', updateMemberData);
}

async function updateMemberData(e) {
    e.preventDefault();
    
    const token = localStorage.getItem('token');
    const formData = {
        name: document.getElementById('member-name').value,
        email: document.getElementById('member-email').value,
        entryDate: document.getElementById('member-entry-date').value,
        exitDate: document.getElementById('member-exit-date').value || null,
        position: document.getElementById('member-position').value
    };

    try {
        const response = await fetch(`${API_BASE_URL}/members/profile`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(formData)
        });

        if (response.ok) {
            alert('Dados atualizados com sucesso!');
        } else {
            alert('Erro ao atualizar dados');
        }
    } catch (error) {
        alert('Erro de conexão');
    }
}

// Utilitários
function formatDate(dateString) {
    return new Date(dateString).toLocaleDateString('pt-BR');
}

function logout() {
    localStorage.removeItem('token');
    localStorage.removeItem('user');
    currentUser = null;
    showScreen('login-screen');
}

// Verificar autenticação ao carregar a página
window.addEventListener('load', () => {
    const token = localStorage.getItem('token');
    const user = localStorage.getItem('user');
    
    if (token && user) {
        currentUser = JSON.parse(user);
        if (currentUser.role === 'admin') {
            showScreen('admin-dashboard');
            loadMembers();
        } else {
            showScreen('member-dashboard');
            loadMemberForm();
        }
    } else {
        showScreen('login-screen');
    }
});
